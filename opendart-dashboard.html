<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenDart API 대시보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: white;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffe6e6;
            border-color: #ff9999;
            color: #cc0000;
        }

        .success {
            background: #e6ffe6;
            border-color: #99ff99;
            color: #006600;
        }

        .company-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .company-item:last-child {
            border-bottom: none;
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .company-details {
            font-size: 0.9em;
            color: #666;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .download-btn:hover {
            background: #218838;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .highlight {
            animation: highlight 1s ease-in-out;
        }

        @keyframes highlight {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
            100% { background-color: transparent; }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .report-detail {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
            min-width: 120px;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 OpenDart API 대시보드</h1>
            <p>공시정보 API를 통한 기업 정보 조회</p>
        </div>

        <div class="content">
            <!-- 통계 섹션 -->
            <div class="section">
                <h2>📈 실시간 통계</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCompanies">-</div>
                        <div class="stat-label">총 기업 수</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayReports">-</div>
                        <div class="stat-label">오늘 공시</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="apiStatus">✅</div>
                        <div class="stat-label">API 상태</div>
                    </div>
                </div>
            </div>

            <!-- 기업 목록 조회 -->
            <div class="section">
                <h2>🏢 기업 목록 조회</h2>
                
                <!-- 기업명 검색 -->
                <div class="form-group">
                    <label for="companyName">기업명 검색:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="companyName" placeholder="예: 삼성전자, SK하이닉스" style="flex: 1;">
                        <button class="btn" onclick="searchByCompanyName()" style="white-space: nowrap;">🔍 기업명 검색</button>
                        <button class="btn" onclick="testButtonClick()" style="white-space: nowrap; background: #dc3545;">🧪 테스트</button>
                    </div>
                    <small style="color: #666; font-size: 0.9em;">
                        💡 기업명을 입력하여 해당 기업의 공시 정보를 바로 검색할 수 있습니다.
                    </small>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                
                <!-- 기존 검색 옵션 -->
                <div class="form-group">
                    <label for="startDate">시작일:</label>
                    <input type="date" id="startDate" value="2024-05-01">
                </div>
                <div class="form-group">
                    <label for="endDate">종료일:</label>
                    <input type="date" id="endDate" value="2024-07-31">
                </div>
                <div class="form-group">
                    <label for="corpClass">기업 분류:</label>
                    <select id="corpClass">
                        <option value="">전체</option>
                        <option value="Y">대표공시사실</option>
                        <option value="K">주요사항보고서</option>
                        <option value="A">정기공시</option>
                        <option value="T">공정공시</option>
                    </select>
                </div>
                <div class="form-group">
                    <small style="color: #666; font-size: 0.9em;">
                        ⚠️ OpenDart API 제한: corp_code가 없는 경우 검색 기간은 3개월만 가능합니다.
                    </small>
                </div>
                <button class="btn" onclick="searchCompanies()">🔍 기업 검색</button>
                <button class="btn" onclick="downloadCSV()">📥 CSV 다운로드</button>
                <button class="btn" onclick="downloadJSON()">📥 JSON 다운로드</button>
                
                <div id="companyResult" class="result" style="display: none;"></div>
            </div>

            <!-- 공시 정보 조회 -->
            <div class="section">
                <h2>📋 공시 정보 조회</h2>
                <div class="form-group">
                    <label for="corpCode">기업 코드:</label>
                    <input type="text" id="corpCode" placeholder="예: 00126380">
                </div>
                <div class="form-group">
                    <label for="bgnDe">시작일:</label>
                    <input type="date" id="bgnDe" value="2024-05-01">
                </div>
                <div class="form-group">
                    <label for="endDe">종료일:</label>
                    <input type="date" id="endDe" value="2024-07-31">
                </div>
                <button class="btn" onclick="searchReports()">📊 공시 조회</button>
                
                <div id="reportResult" class="result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- 공시 상세보기 모달 -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📋 공시 상세 정보</div>
                <span class="close" onclick="closeReportModal()">&times;</span>
            </div>
            <div id="modalContent">
                <!-- 모달 내용이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '447fcb4de167afbabb21ed7ded674931a89ad0b3';
        const PROXY_URL = 'http://localhost:3001';

        // 페이지 로드 시 초기화
        window.addEventListener('load', async () => {
            await checkApiStatus();
            await loadTodayStats();
            setDefaultDateRange();
            
            // 모달 외부 클릭 시 닫기
            const modal = document.getElementById('reportModal');
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeReportModal();
                }
            });
            
            // Enter 키로 기업명 검색
            document.getElementById('companyName').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchByCompanyName();
                }
            });
            
            // 버튼 클릭 이벤트 확인
            const searchButton = document.querySelector('button[onclick="searchByCompanyName()"]');
            if (searchButton) {
                searchButton.addEventListener('click', function(event) {
                    console.log('🔘 기업명 검색 버튼 클릭됨');
                    event.preventDefault();
                    searchByCompanyName();
                });
            }
        });

        // 버튼 클릭 테스트 함수
        function testButtonClick() {
            console.log('🔘 버튼 클릭 테스트 성공');
            alert('버튼이 정상적으로 작동합니다!');
        }

        // 기본 날짜 범위 설정 (3개월)
        function setDefaultDateRange() {
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            document.getElementById('startDate').value = formatDate(threeMonthsAgo);
            document.getElementById('endDate').value = formatDate(today);
            document.getElementById('bgnDe').value = formatDate(threeMonthsAgo);
            document.getElementById('endDe').value = formatDate(today);
        }

        // 파일 다운로드 공통 함수
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // API 상태 확인
        async function checkApiStatus() {
            try {
                const response = await fetch(`${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=20240101&end_de=20240101&page_no=1&page_count=1`);
                const data = await response.json();
                
                if (data.status === '000') {
                    document.getElementById('apiStatus').textContent = '✅';
                    document.getElementById('apiStatus').style.color = '#28a745';
                } else {
                    document.getElementById('apiStatus').textContent = '❌';
                    document.getElementById('apiStatus').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = '❌';
                document.getElementById('apiStatus').style.color = '#dc3545';
            }
        }

        // 오늘 통계 로드
        async function loadTodayStats() {
            try {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const response = await fetch(`${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=${today}&end_de=${today}&page_no=1&page_count=100`);
                const data = await response.json();
                
                if (data.status === '000') {
                    document.getElementById('todayReports').textContent = data.list ? data.list.length : 0;
                }
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }

        // 기업 목록 검색
        async function searchCompanies() {
            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');
            const corpClass = document.getElementById('corpClass').value;
            
            // 검색 기간 제한 확인 (3개월)
            const start = new Date(document.getElementById('startDate').value);
            const end = new Date(document.getElementById('endDate').value);
            const monthsDiff = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
            
            if (monthsDiff > 3) {
                alert('⚠️ OpenDart API 제한사항\n\ncorp_code가 없는 경우 검색 기간은 3개월만 가능합니다.\n\n검색 기간을 3개월 이내로 조정해주세요.');
                return;
            }
            
            const resultDiv = document.getElementById('companyResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">🔍 기업 정보를 검색 중입니다...</div>';
            resultDiv.className = 'result';

            try {
                let url = `${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=${startDate}&end_de=${endDate}&page_no=1&page_count=50`;
                if (corpClass) {
                    url += `&corp_class=${corpClass}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.status === '000' && data.list) {
                    displayCompanies(data.list);
                    document.getElementById('totalCompanies').textContent = data.list.length;
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ 검색 실패: ${data.message || '알 수 없는 오류'}</div>`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 네트워크 오류: ${error.message}</div>`;
                resultDiv.className = 'result error';
            }
        }

        // 기업 목록 표시
        function displayCompanies(companies) {
            const resultDiv = document.getElementById('companyResult');
            
            if (companies.length === 0) {
                resultDiv.innerHTML = '<div class="success">📭 검색 결과가 없습니다.</div>';
                resultDiv.className = 'result success';
                window.lastSearchData = [];
                return;
            }

            // 검색 결과를 전역 변수에 저장 (다운로드용)
            window.lastSearchData = companies;

            let html = `<h3>📊 검색 결과 (${companies.length}개)</h3>`;
            
            companies.forEach(company => {
                html += `
                    <div class="company-item">
                        <div class="company-info">
                            <div class="company-name">${company.corp_name || 'N/A'}</div>
                            <div class="company-details">
                                코드: ${company.corp_code || 'N/A'} | 
                                분류: ${company.corp_class || 'N/A'} | 
                                공시일: ${company.rcept_dt || 'N/A'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="download-btn" onclick="viewReport('${company.corp_code}', '${company.rcept_no}')">
                                📄 보기
                            </button>
                            <button class="download-btn" style="background: #17a2b8;" onclick="searchCompanyReports('${company.corp_code}', '${company.corp_name || ''}')">
                                📋 공시조회
                            </button>
                        </div>
                    </div>
                `;
            });

            resultDiv.innerHTML = html;
            resultDiv.className = 'result success';
        }

        // 기업명으로 검색
        async function searchByCompanyName() {
            const companyName = document.getElementById('companyName').value.trim();
            if (!companyName) {
                alert('검색할 기업명을 입력해주세요.');
                return;
            }

            console.log('🔍 기업명 검색 시작:', companyName);

            const resultDiv = document.getElementById('companyResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">🔍 기업 정보를 검색 중입니다...</div>';
            resultDiv.className = 'result';

            try {
                // 첫 번째 방법: corp_name 파라미터로 검색
                let url = `${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&corp_name=${encodeURIComponent(companyName)}&page_no=1&page_count=50`;
                console.log('📡 API 요청 URL (방법1):', url);
                
                let response = await fetch(url);
                console.log('📥 응답 상태:', response.status);
                
                let data = await response.json();
                console.log('📊 응답 데이터:', data);

                // 첫 번째 방법이 실패하면 두 번째 방법 시도
                if (data.status !== '000' || !data.list || data.list.length === 0) {
                    console.log('🔄 첫 번째 방법 실패, 두 번째 방법 시도');
                    
                    // 두 번째 방법: 일반 검색으로 시도
                    const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                    url = `${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=${today}&end_de=${today}&page_no=1&page_count=100`;
                    
                    response = await fetch(url);
                    data = await response.json();
                    
                    if (data.status === '000' && data.list) {
                        // 클라이언트 사이드에서 기업명 필터링
                        const filteredList = data.list.filter(item => 
                            item.corp_name && item.corp_name.includes(companyName)
                        );
                        
                        if (filteredList.length > 0) {
                            console.log('✅ 필터링 검색 성공, 결과 수:', filteredList.length);
                            displayCompanies(filteredList);
                            document.getElementById('totalCompanies').textContent = filteredList.length;
                            return;
                        }
                    }
                } else {
                    console.log('✅ 검색 성공, 결과 수:', data.list.length);
                    displayCompanies(data.list);
                    document.getElementById('totalCompanies').textContent = data.list.length;
                    return;
                }

                // 모든 방법이 실패한 경우
                console.error('❌ 모든 검색 방법 실패');
                resultDiv.innerHTML = `<div class="error">❌ 검색 실패: "${companyName}"에 대한 결과를 찾을 수 없습니다.</div>`;
                resultDiv.className = 'result error';
                
            } catch (error) {
                console.error('❌ 네트워크 오류:', error);
                resultDiv.innerHTML = `<div class="error">❌ 네트워크 오류: ${error.message}</div>`;
                resultDiv.className = 'result error';
            }
        }

        // 기업의 모든 공시 조회
        async function searchCompanyReports(corpCode, corpName) {
            // 기업코드를 공시정보 조회 섹션에 자동 입력
            document.getElementById('corpCode').value = corpCode;
            
            // 공시정보 조회 섹션으로 스크롤
            document.getElementById('corpCode').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // 하이라이트 효과 추가
            const corpCodeInput = document.getElementById('corpCode');
            corpCodeInput.classList.add('highlight');
            setTimeout(() => {
                corpCodeInput.classList.remove('highlight');
            }, 1000);
            
            // 입력 필드에 포커스 주기
            setTimeout(() => {
                corpCodeInput.focus();
            }, 500);
            
            // 성공 메시지 표시
            const message = `✅ "${corpName}" 기업코드가 자동으로 입력되었습니다!\n\n📋 다음 단계:\n1. 필요시 날짜 범위를 조정하세요\n2. "📊 공시 조회" 버튼을 클릭하세요\n3. 해당 기업의 모든 공시 정보를 확인하세요`;
            alert(message);
        }

        // 공시 정보 조회
        async function searchReports() {
            const corpCode = document.getElementById('corpCode').value;
            const bgnDe = document.getElementById('bgnDe').value.replace(/-/g, '');
            const endDe = document.getElementById('endDe').value.replace(/-/g, '');
            
            if (!corpCode) {
                alert('기업 코드를 입력해주세요.');
                return;
            }

            const resultDiv = document.getElementById('reportResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">📊 공시 정보를 조회 중입니다...</div>';
            resultDiv.className = 'result';

            try {
                const url = `${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&corp_code=${corpCode}&bgn_de=${bgnDe}&end_de=${endDe}&page_no=1&page_count=50`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === '000' && data.list) {
                    displayReports(data.list);
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ 조회 실패: ${data.message || '알 수 없는 오류'}</div>`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 네트워크 오류: ${error.message}</div>`;
                resultDiv.className = 'result error';
            }
        }

        // 공시 정보 표시
        function displayReports(reports) {
            const resultDiv = document.getElementById('reportResult');
            
            if (reports.length === 0) {
                resultDiv.innerHTML = '<div class="success">📭 공시 정보가 없습니다.</div>';
                resultDiv.className = 'result success';
                return;
            }

            let html = `<h3>📋 공시 정보 (${reports.length}개)</h3>`;
            
            reports.forEach(report => {
                html += `
                    <div class="company-item">
                        <div class="company-info">
                            <div class="company-name">${report.report_nm || 'N/A'}</div>
                            <div class="company-details">
                                접수번호: ${report.rcept_no || 'N/A'} | 
                                접수일: ${report.rcept_dt || 'N/A'} | 
                                제출인: ${report.flr_nm || 'N/A'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="download-btn" onclick="viewReportDetail('${report.corp_code}', '${report.rcept_no}', '${report.report_nm || ''}')">
                                📄 상세보기
                            </button>
                            <button class="download-btn" style="background: #17a2b8;" onclick="openDartWebsite('${report.corp_code}', '${report.rcept_no}')">
                                🌐 OpenDart
                            </button>
                        </div>
                    </div>
                `;
            });

            resultDiv.innerHTML = html;
            resultDiv.className = 'result success';
        }

        // 공시 상세 보기
        function viewReport(corpCode, rceptNo) {
            // 기업코드를 공시정보 조회 섹션에 자동 입력
            const corpCodeInput = document.getElementById('corpCode');
            corpCodeInput.value = corpCode;
            
            // 공시정보 조회 섹션으로 스크롤
            corpCodeInput.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // 하이라이트 효과 추가
            corpCodeInput.classList.add('highlight');
            setTimeout(() => {
                corpCodeInput.classList.remove('highlight');
            }, 1000);
            
            // 입력 필드에 포커스 주기
            setTimeout(() => {
                corpCodeInput.focus();
            }, 500);
            
            // 성공 메시지 표시 (더 친화적인 메시지)
            const message = `✅ 기업코드 "${corpCode}"가 자동으로 입력되었습니다!\n\n📋 다음 단계:\n1. 필요시 날짜 범위를 조정하세요\n2. "📊 공시 조회" 버튼을 클릭하세요\n3. 해당 기업의 상세 공시 정보를 확인하세요`;
            alert(message);
        }

        // 공시 상세보기 모달 표시
        function viewReportDetail(corpCode, rceptNo, reportName) {
            const modal = document.getElementById('reportModal');
            const modalContent = document.getElementById('modalContent');
            
            // 로딩 상태 표시
            modalContent.innerHTML = '<div class="loading">📊 공시 정보를 불러오는 중...</div>';
            modal.style.display = 'block';
            
            // 공시 상세 정보 조회
            fetchReportDetail(corpCode, rceptNo, reportName);
        }

        // 공시 상세 정보 조회
        async function fetchReportDetail(corpCode, rceptNo, reportName) {
            try {
                // OpenDart API에서 공시 상세 정보 조회
                const url = `${PROXY_URL}/api/view.json?crtfc_key=${API_KEY}&rcept_no=${rceptNo}`;
                const response = await fetch(url);
                const data = await response.json();
                
                displayReportDetail(data, corpCode, rceptNo, reportName);
            } catch (error) {
                // API 호출 실패 시 기본 정보로 표시
                displayReportDetail(null, corpCode, rceptNo, reportName);
            }
        }

        // 공시 상세 정보 표시
        function displayReportDetail(data, corpCode, rceptNo, reportName) {
            const modalContent = document.getElementById('modalContent');
            
            let html = `
                <div class="report-detail">
                    <div class="detail-row">
                        <div class="detail-label">📋 공시명:</div>
                        <div class="detail-value">${reportName || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">🏢 기업코드:</div>
                        <div class="detail-value">${corpCode || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">📝 접수번호:</div>
                        <div class="detail-value">${rceptNo || 'N/A'}</div>
                    </div>
            `;
            
            if (data && data.status === '000') {
                // API에서 받은 상세 정보 추가
                html += `
                    <div class="detail-row">
                        <div class="detail-label">📅 접수일:</div>
                        <div class="detail-value">${data.rcept_dt || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">👤 제출인:</div>
                        <div class="detail-value">${data.flr_nm || 'N/A'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">📊 공시분류:</div>
                        <div class="detail-value">${data.report_nm || 'N/A'}</div>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-primary" onclick="openDartWebsite('${corpCode}', '${rceptNo}')">
                        🌐 OpenDart에서 보기
                    </button>
                    <button class="action-btn btn-secondary" onclick="copyReportInfo('${corpCode}', '${rceptNo}', '${reportName}')">
                        📋 정보 복사
                    </button>
                    <button class="action-btn btn-success" onclick="downloadReportPDF('${corpCode}', '${rceptNo}')">
                        📄 PDF 다운로드
                    </button>
                </div>
            `;
            
            modalContent.innerHTML = html;
        }

        // 모달 닫기
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // OpenDart 웹사이트 열기
        function openDartWebsite(corpCode, rceptNo) {
            const url = `https://dart.fss.or.kr/dsaf001/main.do?rcpNo=${rceptNo}`;
            window.open(url, '_blank');
        }

        // 공시 정보 복사
        function copyReportInfo(corpCode, rceptNo, reportName) {
            const info = `공시명: ${reportName}\n기업코드: ${corpCode}\n접수번호: ${rceptNo}\nOpenDart 링크: https://dart.fss.or.kr/dsaf001/main.do?rcpNo=${rceptNo}`;
            
            navigator.clipboard.writeText(info).then(() => {
                alert('✅ 공시 정보가 클립보드에 복사되었습니다!');
            }).catch(() => {
                // 클립보드 API가 지원되지 않는 경우
                const textArea = document.createElement('textarea');
                textArea.value = info;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ 공시 정보가 클립보드에 복사되었습니다!');
            });
        }

        // PDF 다운로드 (OpenDart 링크로 이동)
        function downloadReportPDF(corpCode, rceptNo) {
            const url = `https://dart.fss.or.kr/dsaf001/main.do?rcpNo=${rceptNo}`;
            alert('📄 PDF 다운로드를 위해 OpenDart 웹사이트로 이동합니다.\n\nOpenDart에서 "원문보기" 버튼을 클릭하여 PDF를 다운로드하세요.');
            window.open(url, '_blank');
        }

        // CSV 다운로드
        function downloadCSV() {
            const resultDiv = document.getElementById('companyResult');
            if (!resultDiv.innerHTML.includes('company-item')) {
                alert('먼저 기업을 검색해주세요.');
                return;
            }
            
            // 검색된 데이터가 있는지 확인
            if (!window.lastSearchData || !window.lastSearchData.length) {
                alert('다운로드할 데이터가 없습니다. 먼저 기업을 검색해주세요.');
                return;
            }
            
            // CSV 헤더 생성
            const headers = ['기업명', '기업코드', '분류', '공시일', '접수번호', '제출인'];
            const csvContent = [
                headers.join(','),
                ...window.lastSearchData.map(item => [
                    `"${item.corp_name || ''}"`,
                    item.corp_code || '',
                    item.corp_class || '',
                    item.rcept_dt || '',
                    item.rcept_no || '',
                    `"${item.flr_nm || ''}"`
                ].join(','))
            ].join('\n');
            
            // 파일명 생성
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const fileName = `opendart_companies_${startDate}_${endDate}.csv`;
            
            // CSV 파일 다운로드
            downloadFile(csvContent, fileName, 'text/csv');
        }

        // JSON 다운로드
        function downloadJSON() {
            const resultDiv = document.getElementById('companyResult');
            if (!resultDiv.innerHTML.includes('company-item')) {
                alert('먼저 기업을 검색해주세요.');
                return;
            }
            
            // 검색된 데이터가 있는지 확인
            if (!window.lastSearchData || !window.lastSearchData.length) {
                alert('다운로드할 데이터가 없습니다. 먼저 기업을 검색해주세요.');
                return;
            }
            
            // JSON 데이터 준비
            const jsonData = {
                searchInfo: {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    corpClass: document.getElementById('corpClass').value,
                    totalCount: window.lastSearchData.length,
                    exportDate: new Date().toISOString()
                },
                companies: window.lastSearchData
            };
            
            // 파일명 생성
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const fileName = `opendart_companies_${startDate}_${endDate}.json`;
            
            // JSON 파일 다운로드
            downloadFile(JSON.stringify(jsonData, null, 2), fileName, 'application/json');
        }
    </script>
</body>
</html> 