<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회사코드 다운로더</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: white;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffe6e6;
            border-color: #ff9999;
            color: #cc0000;
        }

        .success {
            background: #e6ffe6;
            border-color: #99ff99;
            color: #006600;
        }

        .company-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .company-item:last-child {
            border-bottom: none;
        }

        .company-info {
            flex: 1;
        }

        .company-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .company-details {
            font-size: 0.9em;
            color: #666;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏢 회사코드 다운로더</h1>
            <p>OpenDart API에서 모든 상장기업의 회사코드를 다운로드합니다</p>
        </div>

        <div class="content">
            <!-- 통계 섹션 -->
            <div class="section">
                <h2>📊 다운로드 통계</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCompanies">-</div>
                        <div class="stat-label">총 기업 수</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="downloadedCompanies">-</div>
                        <div class="stat-label">다운로드 완료</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="apiStatus">✅</div>
                        <div class="stat-label">API 상태</div>
                    </div>
                </div>
            </div>

            <!-- 다운로드 섹션 -->
            <div class="section">
                <h2>📥 회사코드 다운로드</h2>
                <p style="margin-bottom: 20px; color: #666;">
                    OpenDart API에서 모든 상장기업의 회사코드와 기업명을 다운로드합니다.
                    이 데이터는 재무제표 시각화 애플리케이션에서 사용됩니다.
                </p>
                
                <button class="btn" onclick="downloadAllCompanies()">🚀 전체 기업 다운로드</button>
                <button class="btn" onclick="downloadByYear()">📅 연도별 다운로드</button>
                <button class="btn" onclick="downloadJSON()">📄 JSON 파일 다운로드</button>
                <button class="btn" onclick="downloadCSV()">📄 CSV 파일 다운로드</button>
                
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div id="downloadResult" class="result" style="display: none;"></div>
            </div>

            <!-- 검색 섹션 -->
            <div class="section">
                <h2>🔍 기업 검색</h2>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                    <input type="text" id="searchCompany" placeholder="기업명을 입력하세요" style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    <button class="btn" onclick="searchCompany()">🔍 검색</button>
                </div>
                
                <div id="searchResult" class="result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '447fcb4de167afbabb21ed7ded674931a89ad0b3';
        const PROXY_URL = 'http://localhost:3001';
        let allCompanies = [];

        // 페이지 로드 시 초기화
        window.addEventListener('load', async () => {
            await checkApiStatus();
            await loadStats();
        });

        // API 상태 확인
        async function checkApiStatus() {
            try {
                const response = await fetch(`${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=20240101&end_de=20240101&page_no=1&page_count=1`);
                const data = await response.json();
                
                if (data.status === '000') {
                    document.getElementById('apiStatus').textContent = '✅';
                    document.getElementById('apiStatus').style.color = '#28a745';
                } else {
                    document.getElementById('apiStatus').textContent = '❌';
                    document.getElementById('apiStatus').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = '❌';
                document.getElementById('apiStatus').style.color = '#dc3545';
            }
        }

        // 통계 로드
        async function loadStats() {
            try {
                const response = await fetch(`${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=20240101&end_de=20241231&page_no=1&page_count=100`);
                const data = await response.json();
                
                if (data.status === '000') {
                    document.getElementById('totalCompanies').textContent = data.total_count || 'N/A';
                }
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }

        // 전체 기업 다운로드
        async function downloadAllCompanies() {
            const resultDiv = document.getElementById('downloadResult');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">🚀 전체 기업 데이터를 다운로드 중입니다...</div>';
            resultDiv.className = 'result';
            progressBar.style.display = 'block';
            
            allCompanies = [];
            
            try {
                // 3개월씩 나누어 다운로드
                const periods = [
                    { start: '20240101', end: '20240331', name: '2024년 1분기' },
                    { start: '20240401', end: '20240630', name: '2024년 2분기' },
                    { start: '20240701', end: '20240930', name: '2024년 3분기' },
                    { start: '20241001', end: '20241231', name: '2024년 4분기' },
                    { start: '20250101', end: '20250331', name: '2025년 1분기' },
                    { start: '20250401', end: '20250630', name: '2025년 2분기' },
                    { start: '20250701', end: '20250930', name: '2025년 3분기' },
                    { start: '20251001', end: '20251231', name: '2025년 4분기' }
                ];
                
                let totalDownloaded = 0;
                
                for (let i = 0; i < periods.length; i++) {
                    const period = periods[i];
                    
                    resultDiv.innerHTML = `<div class="loading">📥 ${period.name} 데이터 다운로드 중... (${i + 1}/${periods.length})</div>`;
                    
                    try {
                        // 각 기간별로 최대 50페이지까지 다운로드
                        for (let page = 1; page <= 50; page++) {
                            const response = await fetch(`${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=${period.start}&end_de=${period.end}&page_no=${page}&page_count=100`);
                            const data = await response.json();
                            
                            if (data.status === '000' && data.list && data.list.length > 0) {
                                allCompanies = allCompanies.concat(data.list);
                                totalDownloaded += data.list.length;
                                
                                // 진행률 업데이트
                                const progress = ((i * 50 + page) / (periods.length * 50)) * 100;
                                progressFill.style.width = Math.min(progress, 100) + '%';
                                
                                resultDiv.innerHTML = `<div class="loading">📥 ${period.name} 데이터 다운로드 중... (${i + 1}/${periods.length}) - 총 ${totalDownloaded}개 기업</div>`;
                                
                                // 더 이상 데이터가 없으면 다음 기간으로
                                if (data.list.length < 100) {
                                    break;
                                }
                            } else {
                                console.log(`${period.name} 페이지 ${page}에서 데이터 없음`);
                                break;
                            }
                        }
                    } catch (error) {
                        console.log(`${period.name} 다운로드 중 오류:`, error.message);
                        // 오류가 발생해도 계속 진행
                        continue;
                    }
                }
                
                // 중복 제거 및 정렬
                const uniqueCompanies = removeDuplicates(allCompanies);
                allCompanies = uniqueCompanies;
                
                document.getElementById('downloadedCompanies').textContent = allCompanies.length;
                
                resultDiv.innerHTML = `<div class="success">✅ 다운로드 완료! 총 ${allCompanies.length}개 기업의 데이터를 수집했습니다.</div>`;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 다운로드 실패: ${error.message}</div>`;
                resultDiv.className = 'result error';
            }
            
            progressBar.style.display = 'none';
        }

        // 중복 제거 함수
        function removeDuplicates(companies) {
            const seen = new Set();
            return companies.filter(company => {
                const key = company.corp_code;
                if (seen.has(key)) {
                    return false;
                } else {
                    seen.add(key);
                    return true;
                }
            });
        }

        // 연도별 다운로드
        async function downloadByYear() {
            const currentYear = new Date().getFullYear();
            const resultDiv = document.getElementById('downloadResult');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">📅 현재 연도 데이터를 다운로드 중입니다...</div>';
            resultDiv.className = 'result';
            progressBar.style.display = 'block';
            
            allCompanies = [];
            
            try {
                // 3개월씩 나누어 다운로드
                const quarters = [
                    { start: `${currentYear}0101`, end: `${currentYear}0331`, name: `${currentYear}년 1분기` },
                    { start: `${currentYear}0401`, end: `${currentYear}0630`, name: `${currentYear}년 2분기` },
                    { start: `${currentYear}0701`, end: `${currentYear}0930`, name: `${currentYear}년 3분기` },
                    { start: `${currentYear}1001`, end: `${currentYear}1231`, name: `${currentYear}년 4분기` }
                ];
                
                let totalDownloaded = 0;
                
                for (let i = 0; i < quarters.length; i++) {
                    const quarter = quarters[i];
                    
                    resultDiv.innerHTML = `<div class="loading">📥 ${quarter.name} 데이터 다운로드 중... (${i + 1}/${quarters.length})</div>`;
                    
                    try {
                        // 각 분기별로 최대 20페이지까지 다운로드
                        for (let page = 1; page <= 20; page++) {
                            const response = await fetch(`${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&bgn_de=${quarter.start}&end_de=${quarter.end}&page_no=${page}&page_count=100`);
                            const data = await response.json();
                            
                            if (data.status === '000' && data.list && data.list.length > 0) {
                                allCompanies = allCompanies.concat(data.list);
                                totalDownloaded += data.list.length;
                                
                                // 진행률 업데이트
                                const progress = ((i * 20 + page) / (quarters.length * 20)) * 100;
                                progressFill.style.width = Math.min(progress, 100) + '%';
                                
                                resultDiv.innerHTML = `<div class="loading">📥 ${quarter.name} 데이터 다운로드 중... (${i + 1}/${quarters.length}) - 총 ${totalDownloaded}개 기업</div>`;
                                
                                // 더 이상 데이터가 없으면 다음 분기로
                                if (data.list.length < 100) {
                                    break;
                                }
                            } else {
                                console.log(`${quarter.name} 페이지 ${page}에서 데이터 없음`);
                                break;
                            }
                        }
                    } catch (error) {
                        console.log(`${quarter.name} 다운로드 중 오류:`, error.message);
                        // 오류가 발생해도 계속 진행
                        continue;
                    }
                }
                
                // 중복 제거 및 정렬
                const uniqueCompanies = removeDuplicates(allCompanies);
                allCompanies = uniqueCompanies;
                
                document.getElementById('downloadedCompanies').textContent = allCompanies.length;
                
                resultDiv.innerHTML = `<div class="success">✅ ${currentYear}년 데이터 다운로드 완료! 총 ${allCompanies.length}개 기업의 데이터를 수집했습니다.</div>`;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 다운로드 실패: ${error.message}</div>`;
                resultDiv.className = 'result error';
            }
            
            progressBar.style.display = 'none';
        }

        // JSON 파일 다운로드
        function downloadJSON() {
            if (allCompanies.length === 0) {
                alert('먼저 기업 데이터를 다운로드해주세요.');
                return;
            }
            
            const jsonData = {
                downloadDate: new Date().toISOString(),
                totalCount: allCompanies.length,
                companies: allCompanies.map(company => ({
                    corp_code: company.corp_code,
                    corp_name: company.corp_name,
                    stock_code: company.stock_code,
                    corp_class: company.corp_class
                }))
            };
            
            const fileName = `corpCodes_${new Date().toISOString().split('T')[0]}.json`;
            downloadFile(JSON.stringify(jsonData, null, 2), fileName, 'application/json');
            
            // 서버에 파일 저장 (실제로는 서버 API가 필요)
            saveToServer(jsonData);
        }

        // 서버에 파일 저장 (실제 구현 필요)
        async function saveToServer(data) {
            try {
                const response = await fetch('/save-corp-codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    console.log('✅ 회사코드 데이터베이스 저장 완료');
                }
            } catch (error) {
                console.log('📝 로컬 저장으로 대체');
                // 로컬 스토리지에 저장
                localStorage.setItem('corpCodes', JSON.stringify(data));
            }
        }

        // CSV 파일 다운로드
        function downloadCSV() {
            if (allCompanies.length === 0) {
                alert('먼저 기업 데이터를 다운로드해주세요.');
                return;
            }
            
            const headers = ['기업코드', '기업명', '종목코드', '분류'];
            const csvContent = [
                headers.join(','),
                ...allCompanies.map(company => [
                    company.corp_code || '',
                    `"${company.corp_name || ''}"`,
                    company.stock_code || '',
                    company.corp_class || ''
                ].join(','))
            ].join('\n');
            
            const fileName = `corpCodes_${new Date().toISOString().split('T')[0]}.csv`;
            downloadFile(csvContent, fileName, 'text/csv');
        }

        // 파일 다운로드 공통 함수
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // 기업 검색
        async function searchCompany() {
            const searchTerm = document.getElementById('searchCompany').value.trim();
            if (!searchTerm) {
                alert('검색할 기업명을 입력해주세요.');
                return;
            }
            
            const resultDiv = document.getElementById('searchResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">🔍 기업을 검색 중입니다...</div>';
            resultDiv.className = 'result';
            
            try {
                const response = await fetch(`${PROXY_URL}/api/list.json?crtfc_key=${API_KEY}&corp_name=${encodeURIComponent(searchTerm)}&page_no=1&page_count=50`);
                const data = await response.json();
                
                if (data.status === '000' && data.list && data.list.length > 0) {
                    let html = `<h3>🔍 검색 결과 (${data.list.length}개)</h3>`;
                    
                    data.list.forEach(company => {
                        html += `
                            <div class="company-item">
                                <div class="company-info">
                                    <div class="company-name">${company.corp_name || 'N/A'}</div>
                                    <div class="company-details">
                                        기업코드: ${company.corp_code || 'N/A'} | 
                                        종목코드: ${company.stock_code || 'N/A'} | 
                                        분류: ${company.corp_class || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<div class="success">📭 "${searchTerm}"에 대한 검색 결과가 없습니다.</div>`;
                    resultDiv.className = 'result success';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 검색 오류: ${error.message}</div>`;
                resultDiv.className = 'result error';
            }
        }

        // Enter 키로 검색
        document.getElementById('searchCompany').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                searchCompany();
            }
        });
    </script>
</body>
</html> 