<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì‚¬ì½”ë“œ ë‹¤ìš´ë¡œë”</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .progress {
            background: #e9ecef;
            border-radius: 5px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #007bff;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .result-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .download-btn {
            background: #28a745;
        }
        .download-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¢ íšŒì‚¬ì½”ë“œ ë‹¤ìš´ë¡œë”</h1>
        
        <div class="warning">
            <strong>âš ï¸ ì¤‘ìš”:</strong> ì´ í˜ì´ì§€ëŠ” ë¡œì»¬ ì„œë²„ì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
            <br>PowerShellì—ì„œ: <code>python -m http.server 8000</code>
            <br>ë¸Œë¼ìš°ì €ì—ì„œ: <code>http://localhost:8000/company-downloader.html</code>
        </div>
        
        <div class="form-group">
            <label for="startDate">ì‹œì‘ì¼:</label>
            <input type="date" id="startDate" value="2024-01-01">
        </div>
        
        <div class="form-group">
            <label for="endDate">ì¢…ë£Œì¼:</label>
            <input type="date" id="endDate">
        </div>
        
        <div class="form-group">
            <label for="corpClass">ë²•ì¸êµ¬ë¶„:</label>
            <select id="corpClass">
                <option value="">ì „ì²´</option>
                <option value="Y">ìœ ê°€ì¦ê¶Œ</option>
                <option value="K">ì½”ìŠ¤ë‹¥</option>
                <option value="N">ì½”ë„¥ìŠ¤</option>
                <option value="E">ê¸°íƒ€</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="pageCount">í˜ì´ì§€ë³„ ê±´ìˆ˜:</label>
            <select id="pageCount">
                <option value="10">10ê±´</option>
                <option value="20">20ê±´</option>
                <option value="50">50ê±´</option>
                <option value="100">100ê±´</option>
            </select>
        </div>
        
        <button onclick="downloadCompanyCodes()">ğŸ“¥ íšŒì‚¬ì½”ë“œ ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadAsCSV()" id="csvBtn" disabled class="download-btn">ğŸ’¾ CSV ë‹¤ìš´ë¡œë“œ</button>
        <button onclick="downloadAsJSON()" id="jsonBtn" disabled class="download-btn">ğŸ“„ JSON ë‹¤ìš´ë¡œë“œ</button>
        
        <div id="status" class="status info" style="display: none;">
            ìƒíƒœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
        
        <div class="progress" id="progressBar" style="display: none;">
            <div class="progress-bar" id="progressBarFill"></div>
        </div>
        
        <div id="resultContainer" style="display: none;">
            <h3>ğŸ“Š ë‹¤ìš´ë¡œë“œ ê²°ê³¼</h3>
            <div id="resultInfo"></div>
            <table class="result-table" id="resultTable">
                <thead>
                    <tr>
                        <th>ë²•ì¸êµ¬ë¶„</th>
                        <th>íšŒì‚¬ëª…</th>
                        <th>ê³ ìœ ë²ˆí˜¸</th>
                        <th>ì¢…ëª©ì½”ë“œ</th>
                        <th>ë³´ê³ ì„œëª…</th>
                        <th>ì ‘ìˆ˜ì¼ì</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // API í‚¤ë¥¼ ì§ì ‘ ì„¤ì •
        const API_KEY = '447fcb4de167afbabb21ed7ded674931a89ad0b3';
        let downloadedData = [];
        
        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
        
        // íšŒì‚¬ì½”ë“œ ë‹¤ìš´ë¡œë“œ
        async function downloadCompanyCodes() {
            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');
            const corpClass = document.getElementById('corpClass').value;
            const pageCount = document.getElementById('pageCount').value;
            
            if (!startDate || !endDate) {
                showStatus('âŒ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            showStatus('ğŸ” íšŒì‚¬ì½”ë“œ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            showProgress(true);
            
            try {
                let allData = [];
                let pageNo = 1;
                let totalPage = 1;
                
                do {
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    updateProgress((pageNo - 1) / Math.max(totalPage, 1) * 100);
                    
                    const url = `https://opendart.fss.or.kr/api/list.json?crtfc_key=${API_KEY}&bgn_de=${startDate}&end_de=${endDate}&corp_cls=${corpClass}&page_no=${pageNo}&page_count=${pageCount}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.status === '000') {
                        if (pageNo === 1) {
                            totalPage = data.total_page;
                            showStatus(`ğŸ“Š ì´ ${data.total_count}ê±´ì˜ ë°ì´í„°ë¥¼ ${totalPage}í˜ì´ì§€ì—ì„œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.`, 'info');
                        }
                        
                        if (data.list && data.list.length > 0) {
                            allData = allData.concat(data.list);
                            showStatus(`ğŸ“¥ ${pageNo}/${totalPage} í˜ì´ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (${allData.length}ê±´)`, 'success');
                        }
                        
                        pageNo++;
                    } else {
                        throw new Error(`API ì˜¤ë¥˜: ${data.message} (ì½”ë“œ: ${data.status})`);
                    }
                    
                    // API í˜¸ì¶œ ê°„ê²© ì¡°ì ˆ (ì„œë²„ ë¶€í•˜ ë°©ì§€)
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } while (pageNo <= totalPage);
                
                downloadedData = allData;
                showProgress(false);
                showStatus(`âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ì´ ${allData.length}ê±´ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, 'success');
                displayResults(allData);
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('csvBtn').disabled = false;
                document.getElementById('jsonBtn').disabled = false;
                
            } catch (error) {
                showProgress(false);
                showStatus(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            }
        }
        
        // ê²°ê³¼ í‘œì‹œ
        function displayResults(data) {
            const container = document.getElementById('resultContainer');
            const info = document.getElementById('resultInfo');
            const tbody = document.getElementById('resultTableBody');
            
            info.innerHTML = `
                <p><strong>ì´ ${data.length}ê±´</strong>ì˜ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.</p>
                <p>ë²•ì¸êµ¬ë¶„ë³„: ${getCorpClassSummary(data)}</p>
            `;
            
            tbody.innerHTML = '';
            data.slice(0, 50).forEach(item => { // ì²˜ìŒ 50ê±´ë§Œ í‘œì‹œ
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${getCorpClassText(item.corp_cls)}</td>
                    <td>${item.corp_name || '-'}</td>
                    <td>${item.corp_code || '-'}</td>
                    <td>${item.stock_code || '-'}</td>
                    <td>${item.report_nm || '-'}</td>
                    <td>${formatDate(item.rcept_dt)}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (data.length > 50) {
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = `<td colspan="6" style="text-align: center; color: #666;">... ì™¸ ${data.length - 50}ê±´ ë”</td>`;
                tbody.appendChild(moreRow);
            }
            
            container.style.display = 'block';
        }
        
        // ë²•ì¸êµ¬ë¶„ ìš”ì•½
        function getCorpClassSummary(data) {
            const summary = {};
            data.forEach(item => {
                const cls = item.corp_cls || 'ê¸°íƒ€';
                summary[cls] = (summary[cls] || 0) + 1;
            });
            
            return Object.entries(summary)
                .map(([cls, count]) => `${getCorpClassText(cls)}: ${count}ê±´`)
                .join(', ');
        }
        
        // ë²•ì¸êµ¬ë¶„ í…ìŠ¤íŠ¸ ë³€í™˜
        function getCorpClassText(cls) {
            const map = {
                'Y': 'ìœ ê°€ì¦ê¶Œ',
                'K': 'ì½”ìŠ¤ë‹¥',
                'N': 'ì½”ë„¥ìŠ¤',
                'E': 'ê¸°íƒ€'
            };
            return map[cls] || cls;
        }
        
        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
        }
        
        // CSV ë‹¤ìš´ë¡œë“œ
        function downloadAsCSV() {
            if (downloadedData.length === 0) {
                showStatus('âŒ ë‹¤ìš´ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const headers = ['ë²•ì¸êµ¬ë¶„', 'íšŒì‚¬ëª…', 'ê³ ìœ ë²ˆí˜¸', 'ì¢…ëª©ì½”ë“œ', 'ë³´ê³ ì„œëª…', 'ì ‘ìˆ˜ë²ˆí˜¸', 'ì ‘ìˆ˜ì¼ì'];
            const csvContent = [
                headers.join(','),
                ...downloadedData.map(item => [
                    getCorpClassText(item.corp_cls),
                    `"${item.corp_name || ''}"`,
                    item.corp_code || '',
                    item.stock_code || '',
                    `"${item.report_nm || ''}"`,
                    item.rcept_no || '',
                    formatDate(item.rcept_dt)
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'company_codes.csv', 'text/csv');
            showStatus('âœ… CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        // JSON ë‹¤ìš´ë¡œë“œ
        function downloadAsJSON() {
            if (downloadedData.length === 0) {
                showStatus('âŒ ë‹¤ìš´ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const jsonContent = JSON.stringify(downloadedData, null, 2);
            downloadFile(jsonContent, 'company_codes.json', 'application/json');
            showStatus('âœ… JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ í—¬í¼ í•¨ìˆ˜
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        // ì§„í–‰ë¥  í‘œì‹œ
        function showProgress(show) {
            document.getElementById('progressBar').style.display = show ? 'block' : 'none';
        }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percent) {
            document.getElementById('progressBarFill').style.width = `${percent}%`;
        }
    </script>
</body>
</html> 